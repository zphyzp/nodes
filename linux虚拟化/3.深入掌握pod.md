# 3.11 pod的升级与回滚

## 升级

```shell
# nginx-deployment.yaml
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 3
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
    
    [root@k8s-master01 c3]# kubectl get pod -o wide
NAME                                READY   STATUS    RESTARTS   AGE    IP             NODE             NOMINATED NODE   READINESS GATES
nginx-deployment-5d59d67564-h7jk5   1/1     Running   0          7m5s   169.168.0.14   192.168.160.12   <none>           <none>
nginx-deployment-5d59d67564-jgp2t   1/1     Running   0          7m5s   169.168.2.3    192.168.160.11   <none>           <none>
nginx-deployment-5d59d67564-qtbqr   1/1     Running   0          7m5s   169.168.1.9    192.168.160.13   <none>           <none>

#现需升级nginx至1.9.1
方法1：kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1
方法2：kubectl edit deployment/nginx-deployment #编辑image的值为nginx:1.9.1

#通过 kubectl rollout status 查看更新过程
kubectl rollout status deployment/nginx-deployment
[root@k8s-master01 ~]# kubectl rollout status deployment/nginx-deployment
Waiting for deployment "nginx-deployment" rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
Waiting for deployment "nginx-deployment" rollout to finish: 1 old replicas are pending termination...
deployment "nginx-deployment" successfully rolled out
 
```

## 回滚

```yml
#检查部署记录
kubectl rollout history deployment/nginx-deployment

#查看特定版本的详细信息
[root@k8s-master01 ~]# kubectl rollout history deployment/nginx-deployment --revision=2
deployment.apps/nginx-deployment with revision #2
Pod Template:
  Labels:	app=nginx
	pod-template-hash=69c44dfb78
  Containers:
   nginx:
    Image:	nginx:1.9.1
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>

[root@k8s-master01 ~]# kubectl rollout history deployment/nginx-deployment --revision=1
deployment.apps/nginx-deployment with revision #1
Pod Template:
  Labels:	app=nginx
	pod-template-hash=5d59d67564
  Containers:
   nginx:
    Image:	nginx:1.7.9
    Port:	80/TCP
    Host Port:	0/TCP
    Environment:	<none>
    Mounts:	<none>
  Volumes:	<none>
  
 #回滚至上一个版本
 kubectl rollout undo deployment/nginx-deployment
 
 #回滚至指定版本
 kubectl rollout undo deployment/nginx-deployment --to-revision=1
 
```



